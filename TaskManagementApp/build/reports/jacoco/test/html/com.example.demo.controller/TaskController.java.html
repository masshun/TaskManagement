<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TaskController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TaskManagementApp</a> &gt; <a href="index.source.html" class="el_package">com.example.demo.controller</a> &gt; <span class="el_source">TaskController.java</span></div><h1>TaskController.java</h1><pre class="source lang-java linenums">package com.example.demo.controller;

import java.security.Principal;
import java.util.Map;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.example.demo.domain.AccountForm;
import com.example.demo.domain.Task;
import com.example.demo.domain.TaskForm;
import com.example.demo.domain.object.PageWrapper;
import com.example.demo.domain.object.SearchForm;
import com.example.demo.service.taskService.TaskNoticeService;
import com.example.demo.service.taskService.TaskService;
import com.example.demo.service.userService.GetUserInfoService;

@Controller
@RequestMapping(&quot;/&quot;)
<span class="fc" id="L33">public class TaskController {</span>

	@Autowired
	GetUserInfoService user;

	@Autowired
	TaskNoticeService taskNoticeService;

	@Autowired
	TaskService taskService;

	@GetMapping
	public String index() {
<span class="fc" id="L46">		return &quot;index&quot;;</span>
	}

	@GetMapping(&quot;/requestedTask&quot;)
	public String requestedTask(Model model, Principal p, @RequestParam(&quot;page&quot;) Optional&lt;Integer&gt; page,
			@RequestParam(&quot;size&quot;) Optional&lt;Integer&gt; size) {
<span class="fc" id="L52">		int userId = user.getLoginUserId(p);</span>
<span class="fc" id="L53">		String param = null;</span>
<span class="fc" id="L54">		taskService.setRequestedTask(userId, param);</span>

<span class="fc" id="L56">		int currentPage = page.orElse(1);</span>
<span class="fc" id="L57">		int pageSize = size.orElse(2);</span>

<span class="fc" id="L59">		Page&lt;Task&gt; notExecutedTask = taskService.getNotExecutedTask(PageRequest.of(currentPage - 1, pageSize));</span>
<span class="fc" id="L60">		Page&lt;Task&gt; completedTask = taskService.getCompletedTask(PageRequest.of(currentPage - 1, pageSize));</span>

<span class="fc" id="L62">		PageWrapper&lt;Task&gt; notExecTaskPageWrapper = taskService.getNotExecTaskPage(notExecutedTask);</span>
<span class="fc" id="L63">		PageWrapper&lt;Task&gt; completedTaskWrapper = new PageWrapper&lt;Task&gt;(completedTask);</span>
<span class="fc" id="L64">		int totalNotExecutedTaskPages = notExecutedTask.getTotalPages();</span>
<span class="fc" id="L65">		int totalCompletedTaskPages = completedTask.getTotalPages();</span>

<span class="fc" id="L67">		model.addAttribute(&quot;notExecutedTask&quot;, notExecutedTask);</span>
<span class="fc" id="L68">		model.addAttribute(&quot;completedTask&quot;, completedTask);</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">		if (totalNotExecutedTaskPages &gt; 0) {</span>
<span class="nc" id="L70">			model.addAttribute(&quot;notExecTaskPage&quot;, notExecTaskPageWrapper);</span>
		}
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">		if (totalCompletedTaskPages &gt; 0) {</span>
<span class="nc" id="L73">			model.addAttribute(&quot;completedTaskPage&quot;, completedTaskWrapper);</span>
		}

<span class="fc" id="L76">		return &quot;task/requestedTask&quot;;</span>
	}

	@GetMapping(&quot;/receivedTask&quot;)
	public String receivedTask(Model model, Principal p, @RequestParam(&quot;page&quot;) Optional&lt;Integer&gt; page,
			@RequestParam(&quot;size&quot;) Optional&lt;Integer&gt; size) {
<span class="fc" id="L82">		int userId = user.getLoginUserId(p);</span>
<span class="fc" id="L83">		String param = null;</span>
<span class="fc" id="L84">		taskService.setReceivedTask(userId, param);</span>

<span class="fc" id="L86">		int currentPage = page.orElse(1);</span>
<span class="fc" id="L87">		int pageSize = size.orElse(2);</span>

<span class="fc" id="L89">		Page&lt;Task&gt; notExecutedTask = taskService.getNotExecutedTask(PageRequest.of(currentPage - 1, pageSize));</span>
<span class="fc" id="L90">		Page&lt;Task&gt; completedTask = taskService.getCompletedTask(PageRequest.of(currentPage - 1, pageSize));</span>

<span class="fc" id="L92">		PageWrapper&lt;Task&gt; notExecTaskPageWrapper = new PageWrapper&lt;Task&gt;(notExecutedTask);</span>
<span class="fc" id="L93">		PageWrapper&lt;Task&gt; completedTaskWrapper = new PageWrapper&lt;Task&gt;(completedTask);</span>
<span class="fc" id="L94">		int totalNotExecutedTaskPages = notExecutedTask.getTotalPages();</span>
<span class="fc" id="L95">		int totalCompletedTaskPages = completedTask.getTotalPages();</span>

<span class="fc" id="L97">		model.addAttribute(&quot;notExecutedTask&quot;, notExecutedTask);</span>
<span class="fc" id="L98">		model.addAttribute(&quot;completedTask&quot;, completedTask);</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">		if (totalNotExecutedTaskPages &gt; 0) {</span>
<span class="nc" id="L100">			model.addAttribute(&quot;notExecTaskPage&quot;, notExecTaskPageWrapper);</span>
		}
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">		if (totalCompletedTaskPages &gt; 0) {</span>
<span class="nc" id="L103">			model.addAttribute(&quot;completedTaskPage&quot;, completedTaskWrapper);</span>
		}

<span class="fc" id="L106">		return &quot;task/receivedTask&quot;;</span>
	}

	@GetMapping(&quot;/readTask/{id}&quot;)
	public String readTask(@PathVariable int id, Model model, AccountForm form) {
<span class="fc" id="L111">		TaskForm task = taskService.findOne(id);</span>
<span class="fc" id="L112">		int senderId = task.getUserId();</span>
<span class="fc" id="L113">		String sender = user.getSenderName(senderId);</span>

<span class="fc" id="L115">		Map&lt;String, String&gt; statusRadio = taskService.getStatusRadio();</span>
<span class="fc" id="L116">		model.addAttribute(&quot;sender&quot;, sender);</span>
<span class="fc" id="L117">		model.addAttribute(&quot;status&quot;, statusRadio);</span>
<span class="fc" id="L118">		model.addAttribute(&quot;form&quot;, form);</span>
<span class="fc" id="L119">		model.addAttribute(&quot;task&quot;, task);</span>
<span class="fc" id="L120">		return &quot;task/readReceivedTask&quot;;</span>
	}

	@PostMapping(&quot;/readTask/{id}&quot;)
	public String postCompleted(@PathVariable int id, @ModelAttribute TaskForm task,
			RedirectAttributes redirectAttributes, Principal p) {
<span class="fc" id="L126">		task.setId(id);</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">		if (task.getStatus().equals(&quot;未完&quot;)) {</span>
<span class="fc" id="L128">			redirectAttributes.addFlashAttribute(&quot;failed&quot;, &quot;すでに進行中になっています&quot;);</span>
<span class="fc" id="L129">			return &quot;redirect:/&quot;;</span>
		}

		// 送り主にメール通知をする
<span class="fc" id="L133">		taskService.updateCompleted(task);</span>
<span class="fc" id="L134">		taskNoticeService.sendCompletedNoticeByMail(task, p);</span>
<span class="fc" id="L135">		redirectAttributes.addFlashAttribute(&quot;successed&quot;, &quot;頼みごとが完了しました&quot;);</span>
<span class="fc" id="L136">		return &quot;redirect:/&quot;;</span>
	}

	@GetMapping(&quot;/createTask&quot;)
	public String createTask(TaskForm taskForm, Model model, Principal p) {
<span class="nc" id="L141">		int userId = user.getLoginUserId(p);</span>
		// デフォルトは進行中
<span class="nc" id="L143">		Map&lt;String, String&gt; selectLabel = taskService.getSelectLabel();</span>
<span class="nc" id="L144">		model.addAttribute(&quot;selectLabel&quot;, selectLabel);</span>
<span class="nc" id="L145">		model.addAttribute(&quot;userId&quot;, userId);</span>
<span class="nc" id="L146">		model.addAttribute(&quot;taskForm&quot;, taskForm);</span>
<span class="nc" id="L147">		return &quot;task/createTask&quot;;</span>
	}

	@PostMapping(&quot;/create&quot;)
	public String createTask(@ModelAttribute @Validated TaskForm taskForm, BindingResult result, Model model,
			RedirectAttributes redirectAttributes, Principal p) {
<span class="fc" id="L153">		int userId = user.getLoginUserId(p);</span>
<span class="pc bpc" id="L154" title="3 of 4 branches missed.">		if (result.hasErrors() || taskForm.getUserAddresseeId() == userId) {</span>
<span class="fc" id="L155">			Map&lt;String, String&gt; selectLabel = taskService.getSelectLabel();</span>
<span class="fc" id="L156">			model.addAttribute(&quot;selectLabel&quot;, selectLabel);</span>
<span class="fc" id="L157">			model.addAttribute(&quot;userId&quot;, userId);</span>
<span class="fc" id="L158">			model.addAttribute(&quot;taskForm&quot;, taskForm);</span>
<span class="fc" id="L159">			return &quot;task/createTask&quot;;</span>
		}
<span class="nc" id="L161">		taskForm.setStatus(&quot;未完&quot;);</span>
<span class="nc" id="L162">		taskService.save(taskForm);</span>

<span class="nc" id="L164">		taskNoticeService.sendNoticeByMail(taskForm, p);</span>
<span class="nc" id="L165">		redirectAttributes.addFlashAttribute(&quot;successed&quot;, &quot;登録が完了しました&quot;);</span>
<span class="nc" id="L166">		return &quot;redirect:/&quot;;</span>
	}

	@GetMapping(&quot;/readRequestedTask/{id}&quot;)
	public String readTask(@PathVariable int id, Model model) {
<span class="nc" id="L171">		TaskForm taskForm = taskService.findOne(id);</span>
<span class="nc" id="L172">		int addresseeId = taskForm.getUserAddresseeId();</span>
<span class="nc" id="L173">		String addressee = user.getAddresseeById(addresseeId);</span>
<span class="nc" id="L174">		model.addAttribute(&quot;addressee&quot;, addressee);</span>
<span class="nc" id="L175">		model.addAttribute(&quot;taskForm&quot;, taskForm);</span>
<span class="nc" id="L176">		return &quot;task/readRequestedTask&quot;;</span>
	}

	@GetMapping(&quot;/edit/{id}&quot;)
	public String editRequiredTask(@PathVariable int id, Model model) {
<span class="fc" id="L181">		TaskForm taskForm = taskService.findOne(id);</span>
<span class="fc" id="L182">		Map&lt;String, String&gt; selectLabel = taskService.getSelectLabel();</span>
<span class="fc" id="L183">		model.addAttribute(&quot;selectLabel&quot;, selectLabel);</span>
<span class="fc" id="L184">		model.addAttribute(&quot;taskForm&quot;, taskForm);</span>
<span class="fc" id="L185">		return &quot;task/editRequestedTask&quot;;</span>
	}

	@PostMapping(&quot;/edit/{id}&quot;)
	public String editRequiredTask(@PathVariable int id, @ModelAttribute @Validated TaskForm taskForm,
			BindingResult result, Model model, RedirectAttributes redirectAttributes, Principal p) {
<span class="nc bnc" id="L191" title="All 4 branches missed.">		if (result.hasErrors() || taskForm.getUserAddresseeId() == user.getLoginUserId(p)) {</span>
<span class="nc" id="L192">			TaskForm form = taskService.findOne(id);</span>
<span class="nc" id="L193">			Map&lt;String, String&gt; selectLabel = taskService.getSelectLabel();</span>
<span class="nc" id="L194">			model.addAttribute(&quot;selectLabel&quot;, selectLabel);</span>
<span class="nc" id="L195">			model.addAttribute(&quot;taskForm&quot;, form);</span>
<span class="nc" id="L196">			model.addAttribute(&quot;failed&quot;, &quot;入力値に問題があります&quot;);</span>
<span class="nc" id="L197">			return &quot;task/editRequestedTask&quot;;</span>
		}
<span class="nc" id="L199">		taskForm.setId(id);</span>
<span class="nc" id="L200">		taskForm.setUserId(user.getLoginUserId(p));</span>
		// 削除しない限りタスクを完了扱いにはしない
<span class="nc" id="L202">		taskForm.setStatus(&quot;未完&quot;);</span>

<span class="nc" id="L204">		taskService.update(taskForm);</span>
<span class="nc" id="L205">		redirectAttributes.addFlashAttribute(&quot;successed&quot;, &quot;更新が完了しました&quot;);</span>
<span class="nc" id="L206">		return &quot;redirect:/&quot;;</span>
	}

	@PostMapping(&quot;/delete/{id}&quot;)
	public String deleteRequiredTask(@PathVariable int id, Model model, RedirectAttributes redirectAttributes) {
<span class="fc" id="L211">		taskService.delete(id);</span>
<span class="fc" id="L212">		redirectAttributes.addFlashAttribute(&quot;successed&quot;, &quot;削除が完了しました&quot;);</span>
<span class="fc" id="L213">		return &quot;redirect:/&quot;;</span>
	}

	@GetMapping(&quot;/searchRequestedTask&quot;)
	public String searchRequestedTask(Principal p, Model model, @ModelAttribute SearchForm form,
			@RequestParam(&quot;page&quot;) Optional&lt;Integer&gt; page, @RequestParam(&quot;size&quot;) Optional&lt;Integer&gt; size) {
<span class="nc" id="L219">		int userId = user.getLoginUserId(p);</span>
<span class="nc" id="L220">		taskService.setRequestedTask(userId, form.getParam());</span>
<span class="nc" id="L221">		int currentPage = page.orElse(1);</span>
<span class="nc" id="L222">		int pageSize = size.orElse(2);</span>

<span class="nc" id="L224">		Page&lt;Task&gt; notExecutedTask = taskService.getNotExecutedTask(PageRequest.of(currentPage - 1, pageSize));</span>
<span class="nc" id="L225">		Page&lt;Task&gt; completedTask = taskService.getCompletedTask(PageRequest.of(currentPage - 1, pageSize));</span>

<span class="nc" id="L227">		PageWrapper&lt;Task&gt; notExecTaskPageWrapper = new PageWrapper&lt;Task&gt;(notExecutedTask);</span>
<span class="nc" id="L228">		PageWrapper&lt;Task&gt; completedTaskWrapper = new PageWrapper&lt;Task&gt;(completedTask);</span>
<span class="nc" id="L229">		int totalNotExecutedTaskPages = notExecutedTask.getTotalPages();</span>
<span class="nc" id="L230">		int totalCompletedTaskPages = completedTask.getTotalPages();</span>

<span class="nc" id="L232">		model.addAttribute(&quot;notExecutedTask&quot;, notExecutedTask);</span>
<span class="nc" id="L233">		model.addAttribute(&quot;completedTask&quot;, completedTask);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">		if (totalNotExecutedTaskPages &gt; 0) {</span>
<span class="nc" id="L235">			model.addAttribute(&quot;notExecTaskPage&quot;, notExecTaskPageWrapper);</span>
		}
<span class="nc bnc" id="L237" title="All 2 branches missed.">		if (totalCompletedTaskPages &gt; 0) {</span>
<span class="nc" id="L238">			model.addAttribute(&quot;completedTaskPage&quot;, completedTaskWrapper);</span>
		}

<span class="nc" id="L241">		return &quot;task/requestedTask&quot;;</span>
	}

	@GetMapping(&quot;/searchReceivedTask&quot;)
	public String searchReceivedTask(Principal p, Model model, @ModelAttribute SearchForm form,
			@RequestParam(&quot;page&quot;) Optional&lt;Integer&gt; page, @RequestParam(&quot;size&quot;) Optional&lt;Integer&gt; size) {
<span class="nc" id="L247">		int userId = user.getLoginUserId(p);</span>
<span class="nc" id="L248">		String param = form.getParam();</span>
<span class="nc" id="L249">		taskService.setReceivedTask(userId, param);</span>

<span class="nc" id="L251">		int currentPage = page.orElse(1);</span>
<span class="nc" id="L252">		int pageSize = size.orElse(2);</span>

<span class="nc" id="L254">		Page&lt;Task&gt; notExecutedTask = taskService.getNotExecutedTask(PageRequest.of(currentPage - 1, pageSize));</span>
<span class="nc" id="L255">		Page&lt;Task&gt; completedTask = taskService.getCompletedTask(PageRequest.of(currentPage - 1, pageSize));</span>

<span class="nc" id="L257">		PageWrapper&lt;Task&gt; notExecTaskPageWrapper = new PageWrapper&lt;Task&gt;(notExecutedTask);</span>
<span class="nc" id="L258">		PageWrapper&lt;Task&gt; completedTaskWrapper = new PageWrapper&lt;Task&gt;(completedTask);</span>
<span class="nc" id="L259">		int totalNotExecutedTaskPages = notExecutedTask.getTotalPages();</span>
<span class="nc" id="L260">		int totalCompletedTaskPages = completedTask.getTotalPages();</span>

<span class="nc" id="L262">		model.addAttribute(&quot;notExecutedTask&quot;, notExecutedTask);</span>
<span class="nc" id="L263">		model.addAttribute(&quot;completedTask&quot;, completedTask);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">		if (totalNotExecutedTaskPages &gt; 0) {</span>
<span class="nc" id="L265">			model.addAttribute(&quot;notExecTaskPage&quot;, notExecTaskPageWrapper);</span>
		}
<span class="nc bnc" id="L267" title="All 2 branches missed.">		if (totalCompletedTaskPages &gt; 0) {</span>
<span class="nc" id="L268">			model.addAttribute(&quot;completedTaskPage&quot;, completedTaskWrapper);</span>
		}

<span class="nc" id="L271">		return &quot;task/receivedTask&quot;;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>